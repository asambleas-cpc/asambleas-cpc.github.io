<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet SVG Overlay with Rotation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="leaflet-rotate.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        /* Transition for SVG layers */
        #map svg g {
            transition: filter 0.5s ease-in-out; /* Adjust duration and timing function as needed */
        }
        /* Transition for basemap */
        .leaflet-tile-pane {
            transition: filter 0.5s ease-in-out; /* Adjust duration and timing function as needed */
        }
        .basemap-blurred {
            filter: blur(3px); /* Adjust blur amount as needed */
        }
        #controls-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease-in-out;
        }
        #floor-controls {
            margin-bottom: 10px;
        }
        #floor-controls button {
            display: inline-block;
            width: 100px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f8f8f8;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out;
        }
        #floor-controls button.active {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        #feature-controls h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        #feature-controls label {
            display: block;
            margin-bottom: 5px;
        }
        #feature-controls input[type="checkbox"] {
            margin-right: 5px;
        }
        /* Style for highlighted SVG elements */
        .highlight {
            fill: #ff0000 !important; /* Bright red fill, !important to override inline styles if any */
            stroke: #ffff00; /* Bright yellow stroke */
            stroke-width: 5px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 0, 0.8));
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="floating-tooltip" style="display: none; position: absolute; background: white; padding: 5px; border: 1px solid #ccc; border-radius: 3px; z-index: 1001;"></div>

    <div id="controls-container">
        <div id="floor-controls">
            <button id="btnPlantaBaja">Planta Baja</button><button id="btnPlantaAlta">Planta Alta</button>
            
        </div>
        <div id="feature-controls">
            <select id="layer-selector" style="width: 100%; padding: 8px; border-radius: 3px; border: 1px solid #ccc;">
                <option value="Iconos">Instalaciones y departamentos</option>
                <option value="AccesoAuditorios">Acceso a auditorios</option>
                <option value="CirculacionGuardaAlimentos">Guardado de alimentos</option>
                <option value="RutasEscape">Salidas de emergencia</option>
            </select>
        </div>
    </div>

    

    <script>
        // 1. Define the corner coordinates
        const bounds = L.latLngBounds([
            [-31.72236, -60.52612], // Southwest corner
            [-31.72096, -60.52442]  // Northeast corner
        ]);

        // 2. Initialize the map
        const map = L.map('map', {
            maxZoom: 24,
            rotate: true // Enable rotation
        }).setView(bounds.getCenter(), 20);

        // Set the map rotation (bearing) in degrees. Adjust the value as needed.
        map.setBearing(-9.8);

        // 3. Add the OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>',
            maxZoom: 24,
            maxNativeZoom: 19 // Add this line to prevent 400 errors beyond native zoom
        }).addTo(map);

        // 4. Define the SVG image URL
        const svgUrl = 'cpc.svg';

        // 5. Fetch the SVG content, then create the overlay
        fetch(svgUrl)
            .then(response => response.text())
            .then(svgText => {
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;

                // 6. Create the SVG overlay with the actual SVG element
                const svgOverlay = L.svgOverlay(svgElement, bounds, {
                    opacity: 1,
                    interactive: true
                }).addTo(map);

                // Get references to the SVG layers
                const layPlantaAlta = svgElement.querySelector('#layPlantaAlta');
                const layPlantaBaja = svgElement.querySelector('#layPlantaBaja');
                console.log('SVG Layer - Planta Alta:', layPlantaAlta);
                console.log('SVG Layer - Planta Baja:', layPlantaBaja);

                // Get references to the control buttons
                const btnPlantaAlta = document.getElementById('btnPlantaAlta');
                const btnPlantaBaja = document.getElementById('btnPlantaBaja');
                console.log('Button - Planta Alta:', btnPlantaAlta);
                console.log('Button - Planta Baja:', btnPlantaBaja);

                // Get reference to the layer selector
                const layerSelector = document.getElementById('layer-selector');

                // Get references to the feature SVG groups (assuming they are direct children of floor layers)
                const features = {
                    'Iconos': { element: null, id: 'layIconos' },
                    'AccesoAuditorios': { element: null, id: 'layAccesoAuditorios' },
                    'CirculacionGuardaAlimentos': { element: null, id: 'layCirculacionGuardaAlimentos' },
                    'RutasEscape': { element: null, id: 'layRutasEscape' }
                };

                // Function to update feature visibility based on active floor and selected layer
                function updateFeatureVisibility(activeFloorName, selectedLayer) {
                    const floorSuffix = activeFloorName === 'PlantaAlta' ? 'PA' : 'PB';

                    // Hide all feature layers first
                    for (const featureKey in features) {
                        const baseFeatureId = features[featureKey].id;
                        const featureIdPA = `${baseFeatureId}PA`;
                        const featureIdPB = `${baseFeatureId}PB`;
                        const featureElementPA = svgElement.querySelector(`#${featureIdPA}`);
                        const featureElementPB = svgElement.querySelector(`#${featureIdPB}`);
                        if (featureElementPA) featureElementPA.style.display = 'none';
                        if (featureElementPB) featureElementPB.style.display = 'none';
                    }

                    // Show the selected layer
                    const selectedFeatureId = `${features[selectedLayer].id}${floorSuffix}`;
                    const selectedFeatureElement = svgElement.querySelector(`#${selectedFeatureId}`);
                    if (selectedFeatureElement) {
                        selectedFeatureElement.style.display = 'block';
                    }
                }

                // Function to apply blur filter
                function applyBlur(element) {
                    if (element) {
                        element.style.filter = 'url(#blur-filter)';
                    }
                }

                // Function to remove blur filter
                function removeBlur(element) {
                    if (element) {
                        element.style.filter = '';
                    }
                }

                // Function to show a floor and blur the other
                function showFloor(floorName) {
                    const tilePane = map.getPane('tilePane');
                    if (layPlantaAlta && layPlantaBaja && tilePane) {
                        if (floorName === 'PlantaAlta') {
                            layPlantaAlta.style.display = 'block';
                            removeBlur(layPlantaAlta); // Ensure Planta Alta is clear
                            layPlantaBaja.style.display = 'block'; // Keep Planta Baja visible for blur
                            applyBlur(layPlantaBaja); // Apply blur to Planta Baja
                            tilePane.classList.add('basemap-blurred'); // Blur the basemap
                            btnPlantaAlta.classList.add('active');
                            btnPlantaBaja.classList.remove('active');
                        } else if (floorName === 'PlantaBaja') {
                            layPlantaAlta.style.display = 'none'; // Hide Planta Alta
                            layPlantaBaja.style.display = 'block';
                            removeBlur(layPlantaBaja); // Ensure Planta Baja is clear
                            removeBlur(layPlantaAlta); // Also ensure Planta Alta is not blurred if it was, though it's hidden
                            tilePane.classList.remove('basemap-blurred'); // Unblur the basemap
                            btnPlantaAlta.classList.remove('active');
                            btnPlantaBaja.classList.add('active');
                        }
                        updateFeatureVisibility(floorName, layerSelector.value);
                    }
                }

                // Initial state: Show Planta Alta
                let currentActiveFloor = 'PlantaBaja';
                showFloor(currentActiveFloor);

                // Add event listeners to buttons
                btnPlantaAlta.addEventListener('click', () => {
                    currentActiveFloor = 'PlantaAlta';
                    showFloor(currentActiveFloor);
                });
                btnPlantaBaja.addEventListener('click', () => {
                    currentActiveFloor = 'PlantaBaja';
                    showFloor(currentActiveFloor);
                });

                // Add event listener to the layer selector
                layerSelector.addEventListener('change', (event) => {
                    mostrarMapa(currentActiveFloor, event.target.value);
                });

                // --- mostrarMapa function and helpers ---
                let highlightedElement = null;

                function clearHighlight() {
                    if (highlightedElement) {
                        highlightedElement.classList.remove('highlight');
                        highlightedElement = null;
                    }
                }

                function mostrarMapa(piso, capa, elemento) {
                    // 1. Switch floor if necessary
                    if (piso && piso !== currentActiveFloor) {
                        showFloor(piso);
                        currentActiveFloor = piso;
                    }

                    // 2. Control layer visibility
                    if (capa) {
                        const floorSuffix = currentActiveFloor === 'PlantaAlta' ? 'PA' : 'PB';
                        const layerId = `lay${capa}${floorSuffix}`;
                        const layerElement = svgElement.querySelector(`#${layerId}`);
                        
                        // Hide all layers first
                        for (const featureKey in features) {
                            const baseFeatureId = features[featureKey].id;
                            const featureIdPA = `${baseFeatureId}PA`;
                            const featureIdPB = `${baseFeatureId}PB`;
                            const featureElementPA = svgElement.querySelector(`#${featureIdPA}`);
                            const featureElementPB = svgElement.querySelector(`#${featureIdPB}`);
                            if(featureElementPA) featureElementPA.style.display = 'none';
                            if(featureElementPB) featureElementPB.style.display = 'none';
                        }

                        // Show the selected layer
                        if (layerElement) {
                            layerElement.style.display = 'block';
                        }
                    }

                    // 3. Highlight a specific element
                    clearHighlight();
                    if (elemento) {
                        const elementToHighlight = svgElement.querySelector(`#${elemento}`);
                        if (elementToHighlight) {
                            elementToHighlight.classList.add('highlight');
                            highlightedElement = elementToHighlight;
                        }
                    }
                }

                // Example of how to use the function:
                // mostrarMapa('PlantaAlta', 'RutasEscape', 'some_element_id_to_highlight');

                // --- Interactivity Example (from previous code) ---
                // Now you can safely add event listeners to elements inside the SVG.

                const customTexts = {
                    // Planta Alta
                    'icon_id_1_pa': 'Custom text for icon 1 on Planta Alta',
                    'icon_id_2_pa': 'Custom text for icon 2 on Planta Alta',
                    // Planta Baja
                    'icon_id_1_pb': 'Custom text for icon 1 on Planta Baja',
                    'icon_id_2_pb': 'Custom text for icon 2 on Planta Baja',
                };

                const tooltip = document.getElementById('floating-tooltip');
                const iconosLayers = svgElement.querySelectorAll('#layIconosPA, #layIconosPB');

                iconosLayers.forEach(layer => {
                    layer.addEventListener('mousemove', function(event) {
                        const target = event.target.closest('g');
                        if (target) {
                            const iconId = target.id;
                            const text = customTexts[iconId] || `Tooltip for ${iconId}`;
                            tooltip.innerHTML = text;
                            tooltip.style.display = 'block';
                            tooltip.style.left = `${event.pageX + 10}px`;
                            tooltip.style.top = `${event.pageY + 10}px`;
                        }
                    });

                    layer.addEventListener('mouseout', function() {
                        tooltip.style.display = 'none';
                    });
                });
            })
            .catch(error => {
                console.error('Error loading or parsing SVG:', error);
                alert('Could not load the SVG file. Please check the file path and ensure it is a valid SVG.');
            });

    </script>

</body>
</html>